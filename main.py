import logging
import time

import coloredlogs

from coordinates import create_runoff_polygon_latlon, classify_to_la
from flightaware import to_positions, get_flight_positions
from fs import read_json_file
from geojson import wrap_as_feature_collection, write_geojson_file

logger = logging.getLogger(__name__)

coloredlogs.install(level='INFO')

# Sample Response used for testing FlightAware
json_response = {'flights': [{'ident': 'N4323J', 'ident_icao': None, 'ident_iata': None, 'fa_flight_id': 'N4323J-1750750183-adhoc-57p', 'actual_off': '2025-06-24T07:29:24Z', 'actual_on': None, 'foresight_predictions_available': False, 'predicted_out': None, 'predicted_off': None, 'predicted_on': None, 'predicted_in': None, 'predicted_out_source': None, 'predicted_off_source': None, 'predicted_on_source': None, 'predicted_in_source': None, 'origin': {'code': 'L 21.46667 -157.65000', 'code_icao': None, 'code_iata': None, 'code_lid': None, 'timezone': 'Pacific/Honolulu', 'name': None, 'city': 'Kaneohe', 'airport_info_url': None}, 'destination': None, 'waypoints': [], 'first_position_time': '2025-06-24T07:29:24Z', 'last_position': {'fa_flight_id': 'N4323J-1750750183-adhoc-57p', 'altitude': 73, 'altitude_change': 'D', 'groundspeed': 70, 'heading': 90, 'latitude': 20.88771593687091, 'longitude': -156.4372848842384, 'timestamp': '2025-06-24T07:51:27Z', 'update_type': 'Z'}, 'bounding_box': [21.46667, -157.64999, 21.25, -157.26666], 'ident_prefix': None, 'aircraft_type': None}, {'ident': 'UAL2220', 'ident_icao': 'UAL2220', 'ident_iata': 'UA2220', 'fa_flight_id': 'UAL2220-1750493704-airline-1129p', 'actual_off': '2025-06-24T07:59:59Z', 'actual_on': None, 'foresight_predictions_available': True, 'predicted_out': None, 'predicted_off': None, 'predicted_on': None, 'predicted_in': None, 'predicted_out_source': None, 'predicted_off_source': None, 'predicted_on_source': None, 'predicted_in_source': None, 'origin': {'code': 'PHOG', 'code_icao': 'PHOG', 'code_iata': 'OGG', 'code_lid': 'OGG', 'timezone': 'Pacific/Honolulu', 'name': 'Kahului', 'city': 'Kahului', 'airport_info_url': '/airports/PHOG'}, 'destination': {'code': 'KLAX', 'code_icao': 'KLAX', 'code_iata': 'LAX', 'code_lid': 'LAX', 'timezone': 'America/Los_Angeles', 'name': 'Los Angeles Intl', 'city': 'Los Angeles', 'airport_info_url': '/airports/KLAX'}, 'waypoints': [20.9, -156.43, 20.93, -156.33, 20.94, -156.28, 20.94, -156.26, 20.95, -156.23, 20.96, -156.18, 20.97, -156.16, 21.01, -156.01, 21.01, -156, 21.05, -155.83, 21.09, -155.67, 21.14, -155.49, 21.19, -155.29, 21.24, -155.08, 21.25, -155.04, 21.26, -155, 21.29, -154.87, 21.3, -154.84, 21.39, -154.49, 21.71, -153.15, 22.34, -151.89, 22.36, -151.85, 25.28, -145.51, 27.91, -138.86, 30.29, -131.64, 32.24, -124.1, 32.25, -124.07, 32.26, -124.02, 32.47, -123, 32.68, -122.05, 33.05, -121.09, 33.24, -120.6, 33.27, -120.52, 33.33, -120.36, 33.39, -120.19, 33.41, -120.13, 33.51, -119.88, 33.6, -119.61, 33.62, -119.55, 33.65, -119.5, 33.67, -119.44, 33.7, -119.34, 33.71, -119.33, 33.71, -119.32, 33.78, -119.13, 33.8, -119.05, 33.84, -118.95, 33.86, -118.91, 33.86, -118.89, 33.87, -118.86, 33.88, -118.85, 33.89, -118.75, 33.9, -118.7, 33.91, -118.64, 33.91, -118.63, 33.91, -118.6, 33.92, -118.59, 33.92, -118.55, 33.93, -118.5, 33.94, -118.41], 'first_position_time': '2025-06-24T07:49:00Z', 'last_position': {'fa_flight_id': 'UAL2220-1750493704-airline-1129p', 'altitude': 145, 'altitude_change': 'C', 'groundspeed': 380, 'heading': 71, 'latitude': 21.08949, 'longitude': -155.88126, 'timestamp': '2025-06-24T08:07:15Z', 'update_type': 'A'}, 'bounding_box': [21.08949, -156.43771, 20.88953, -155.88126], 'ident_prefix': None, 'aircraft_type': 'B38M'}, {'ident': 'UAL1806', 'ident_icao': 'UAL1806', 'ident_iata': 'UA1806', 'fa_flight_id': 'UAL1806-1750493106-airline-1251p', 'actual_off': '2025-06-24T07:53:48Z', 'actual_on': None, 'foresight_predictions_available': True, 'predicted_out': None, 'predicted_off': None, 'predicted_on': None, 'predicted_in': None, 'predicted_out_source': None, 'predicted_off_source': None, 'predicted_on_source': None, 'predicted_in_source': None, 'origin': {'code': 'PHNL', 'code_icao': 'PHNL', 'code_iata': 'HNL', 'code_lid': 'HNL', 'timezone': 'Pacific/Honolulu', 'name': 'Daniel K Inouye Intl', 'city': 'Honolulu', 'airport_info_url': '/airports/PHNL'}, 'destination': {'code': 'KDEN', 'code_icao': 'KDEN', 'code_iata': 'DEN', 'code_lid': 'DEN', 'timezone': 'America/Denver', 'name': 'Denver Intl', 'city': 'Denver', 'airport_info_url': '/airports/KDEN'}, 'waypoints': [21.32, -157.92, 21.32, -157.92, 21.29, -157.8, 21.27, -157.71, 21.24, -157.6, 21.21, -157.49, 21.2, -157.41, 21.17, -157.31, 21.14, -157.17, 21.17, -157.1, 21.21, -156.98, 21.3, -156.77, 21.33, -156.67, 21.34, -156.59, 21.34, -156.52, 21.34, -156.51, 21.35, -156.35, 21.35, -156.34, 21.36, -156.27, 21.37, -156.12, 21.39, -155.81, 21.39, -155.66, 21.42, -155.14, 21.46, -154.87, 21.71, -153.15, 22.34, -151.89, 22.36, -151.85, 23.48, -149.51, 25.28, -145.51, 27.91, -138.86, 30.29, -131.64, 30.61, -130.83, 32.43, -125.85, 32.91, -124.39, 32.92, -124.36, 33.07, -123.92, 33.48, -122.58, 34.31, -120.33, 34.51, -119.77, 34.54, -119.33, 34.57, -118.9, 34.63, -118.06, 34.67, -117.97, 34.8, -117.67, 35.09, -117, 35.13, -116.91, 35.25, -116.61, 35.5, -116, 35.63, -115.63, 36.09, -114.29, 36.22, -113.93, 37.04, -111.73, 37.22, -111.22, 37.33, -110.95, 37.64, -110.14, 37.85, -109.6, 38.06, -109.05, 38.1, -108.94, 38.41, -108.15, 38.46, -108.01, 38.65, -107.49, 39, -106.58, 39.01, -106.56, 39.03, -106.5, 39.15, -106.16, 39.17, -106.12, 39.19, -106.04, 39.24, -105.92, 39.26, -105.86, 39.3, -105.74, 39.32, -105.69, 39.32, -105.67, 39.35, -105.59, 39.37, -105.54, 39.39, -105.48, 39.42, -105.42, 39.48, -105.3, 39.51, -105.25, 39.54, -105.19, 39.58, -105.12, 39.61, -105.06, 39.69, -104.92, 39.73, -104.84, 39.83, -104.84, 39.84, -104.84, 39.92, -104.84, 39.87, -104.7, 39.86, -104.67], 'first_position_time': '2025-06-24T07:29:26Z', 'last_position': {'fa_flight_id': 'UAL1806-1750493106-airline-1251p', 'altitude': 266, 'altitude_change': 'C', 'groundspeed': 523, 'heading': 78, 'latitude': 21.38026, 'longitude': -156.46379, 'timestamp': '2025-06-24T08:07:18Z', 'update_type': 'A'}, 'bounding_box': [21.38026, -157.94089, 21.21106, -156.46379], 'ident_prefix': None, 'aircraft_type': 'B772'}, {'ident': 'ASA880', 'ident_icao': 'ASA880', 'ident_iata': 'AS880', 'fa_flight_id': 'ASA880-1750577559-schedule-458p', 'actual_off': '2025-06-24T07:45:50Z', 'actual_on': None, 'foresight_predictions_available': True, 'predicted_out': None, 'predicted_off': None, 'predicted_on': None, 'predicted_in': None, 'predicted_out_source': None, 'predicted_off_source': None, 'predicted_on_source': None, 'predicted_in_source': None, 'origin': {'code': 'PHKO', 'code_icao': 'PHKO', 'code_iata': 'KOA', 'code_lid': 'KOA', 'timezone': 'Pacific/Honolulu', 'name': 'Ellison Onizuka Kona Intl At Keahole', 'city': 'Kailua/Kona', 'airport_info_url': '/airports/PHKO'}, 'destination': {'code': 'KSEA', 'code_icao': 'KSEA', 'code_iata': 'SEA', 'code_lid': 'SEA', 'timezone': 'America/Los_Angeles', 'name': 'Seattle-Tacoma Intl', 'city': 'Seattle', 'airport_info_url': '/airports/KSEA'}, 'waypoints': [19.73, -156.05, 19.81, -156.09, 19.82, -156.08, 19.88, -156.04, 19.91, -156.03, 19.95, -156, 19.96, -155.99, 20.04, -155.94, 20.1, -155.91, 20.2, -155.84, 20.24, -155.85, 20.4, -155.87, 20.5, -156.6, 20.62, -156.59, 20.98, -156.56, 21.05, -156.56, 21.27, -156.54, 21.55, -156.52, 21.84, -156.5, 22.6, -156.44, 24.04, -156.32, 24.72, -155.26, 24.75, -155.23, 25.43, -154.5, 30.05, -149.09, 30.69, -148.28, 31.32, -147.47, 31.95, -146.64, 35, -142.34, 35.07, -142.26, 40, -136, 40.51, -135.2, 43, -131, 44.27, -128.91, 45.51, -126.72, 45.51, -126.72, 45.51, -126.72, 45.52, -126.69, 46.34, -125.2, 46.41, -125.07, 46.49, -124.63, 46.55, -124.25, 46.57, -124.15, 46.61, -123.94, 46.65, -123.72, 46.66, -123.64, 46.71, -123.31, 46.75, -122.96, 46.78, -122.74, 46.84, -122.67, 46.87, -122.64, 46.93, -122.57, 46.94, -122.56, 47.01, -122.53, 47.08, -122.5, 47.08, -122.5, 47.19, -122.48, 47.23, -122.47, 47.35, -122.46, 47.39, -122.46, 47.41, -122.46, 47.44, -122.46, 47.45, -122.46, 47.48, -122.46, 47.51, -122.46, 47.49, -122.39, 47.45, -122.31], 'first_position_time': '2025-06-24T07:26:25Z', 'last_position': {'fa_flight_id': 'ASA880-1750577559-schedule-458p', 'altitude': 310, 'altitude_change': 'C', 'groundspeed': 498, 'heading': 20, 'latitude': 21.70193, 'longitude': -156.43562, 'timestamp': '2025-06-24T08:07:38Z', 'update_type': 'A'}, 'bounding_box': [21.70193, -156.62874, 19.70242, -156.04218], 'ident_prefix': None, 'aircraft_type': 'B38M'}, {'ident': 'DAL418', 'ident_icao': 'DAL418', 'ident_iata': 'DL418', 'fa_flight_id': 'DAL418-1750479599-fa-992p', 'actual_off': '2025-06-24T03:19:13Z', 'actual_on': None, 'foresight_predictions_available': True, 'predicted_out': None, 'predicted_off': None, 'predicted_on': None, 'predicted_in': None, 'predicted_out_source': None, 'predicted_off_source': None, 'predicted_on_source': None, 'predicted_in_source': None, 'origin': {'code': 'KLAX', 'code_icao': 'KLAX', 'code_iata': 'LAX', 'code_lid': 'LAX', 'timezone': 'America/Los_Angeles', 'name': 'Los Angeles Intl', 'city': 'Los Angeles', 'airport_info_url': '/airports/KLAX'}, 'destination': {'code': 'PHOG', 'code_icao': 'PHOG', 'code_iata': 'OGG', 'code_lid': 'OGG', 'timezone': 'Pacific/Honolulu', 'name': 'Kahului', 'city': 'Kahului', 'airport_info_url': '/airports/PHOG'}, 'waypoints': [33.94, -118.41, 33.9, -118.66, 33.89, -118.74, 33.87, -118.83, 33.86, -118.91, 33.86, -118.91, 33.85, -118.99, 33.83, -119.08, 33.82, -119.16, 33.78, -119.41, 33.77, -119.47, 33.76, -119.5, 33.73, -119.67, 33.67, -120, 33.6, -120.41, 33.53, -120.83, 33.51, -120.91, 33.51, -120.91, 32.83, -124.31, 32.83, -124.35, 32.76, -124.68, 31.4, -130.28, 29.57, -136.42, 28.56, -139.4, 26.01, -146.17, 24.55, -149.41, 23.02, -152.58, 23.01, -152.61, 22.92, -152.77, 22.36, -153.88, 22.06, -154.41, 21.96, -154.58, 21.95, -154.6, 21.92, -154.66, 21.89, -154.73, 21.88, -154.73, 21.77, -154.95, 21.67, -155.15, 21.59, -155.32, 21.51, -155.48, 21.5, -155.48, 21.36, -155.77, 21.35, -155.78, 21.27, -155.94, 21.18, -156.11, 21.17, -156.12, 21.17, -156.13, 21.16, -156.13, 21.07, -156.21, 21.03, -156.23, 21.03, -156.24, 21.02, -156.24, 20.96, -156.29, 20.95, -156.29, 20.91, -156.33, 20.89, -156.34, 20.89, -156.34, 20.9, -156.4, 20.9, -156.43], 'first_position_time': '2025-06-24T03:05:30Z', 'last_position': {'fa_flight_id': 'DAL418-1750479599-fa-992p', 'altitude': 97, 'altitude_change': 'D', 'groundspeed': 315, 'heading': 240, 'latitude': 21.19762, 'longitude': -156.08041, 'timestamp': '2025-06-24T08:07:27Z', 'update_type': 'A'}, 'bounding_box': [33.95038, -156.08041, 21.19762, -118.39918], 'ident_prefix': None, 'aircraft_type': 'A21N'}, {'ident': 'N4232J', 'ident_icao': None, 'ident_iata': None, 'fa_flight_id': 'N4232J-1750748087-adhoc-1056p', 'actual_off': '2025-06-24T06:58:16Z', 'actual_on': None, 'foresight_predictions_available': False, 'predicted_out': None, 'predicted_off': None, 'predicted_on': None, 'predicted_in': None, 'predicted_out_source': None, 'predicted_off_source': None, 'predicted_on_source': None, 'predicted_in_source': None, 'origin': {'code': 'L 21.73300 -158.25713', 'code_icao': None, 'code_iata': None, 'code_lid': None, 'timezone': 'Pacific/Honolulu', 'name': None, 'city': 'Mokuleia', 'airport_info_url': None}, 'destination': None, 'waypoints': [], 'first_position_time': '2025-06-24T06:54:42Z', 'last_position': {'fa_flight_id': 'N4232J-1750748087-adhoc-1056p', 'altitude': 11, 'altitude_change': 'D', 'groundspeed': 70, 'heading': 180, 'latitude': 21.13333, 'longitude': -157.10001, 'timestamp': '2025-06-24T08:05:04Z', 'update_type': 'Z'}, 'bounding_box': [21.733, -158.25713, 21.13333, -157.08333], 'ident_prefix': None, 'aircraft_type': 'P28A'}, {'ident': 'UAL1169', 'ident_icao': 'UAL1169', 'ident_iata': 'UA1169', 'fa_flight_id': 'UAL1169-1750493041-airline-715p', 'actual_off': '2025-06-24T07:57:03Z', 'actual_on': None, 'foresight_predictions_available': True, 'predicted_out': None, 'predicted_off': None, 'predicted_on': None, 'predicted_in': None, 'predicted_out_source': None, 'predicted_off_source': None, 'predicted_on_source': None, 'predicted_in_source': None, 'origin': {'code': 'PHNL', 'code_icao': 'PHNL', 'code_iata': 'HNL', 'code_lid': 'HNL', 'timezone': 'Pacific/Honolulu', 'name': 'Daniel K Inouye Intl', 'city': 'Honolulu', 'airport_info_url': '/airports/PHNL'}, 'destination': {'code': 'KLAX', 'code_icao': 'KLAX', 'code_iata': 'LAX', 'code_lid': 'LAX', 'timezone': 'America/Los_Angeles', 'name': 'Los Angeles Intl', 'city': 'Los Angeles', 'airport_info_url': '/airports/KLAX'}, 'waypoints': [21.32, -157.92, 21.32, -157.92, 21.29, -157.8, 21.27, -157.71, 21.24, -157.6, 21.21, -157.49, 21.2, -157.41, 21.17, -157.31, 21.14, -157.17, 21.17, -157.1, 21.21, -156.98, 21.3, -156.77, 21.33, -156.67, 21.34, -156.59, 21.34, -156.52, 21.34, -156.51, 21.35, -156.35, 21.35, -156.34, 21.36, -156.27, 21.37, -156.12, 21.39, -155.81, 21.39, -155.66, 21.42, -155.14, 21.46, -154.87, 21.71, -153.15, 22.34, -151.89, 22.36, -151.85, 25.28, -145.51, 27.91, -138.86, 30.29, -131.64, 32.24, -124.1, 32.25, -124.07, 32.26, -124.02, 32.47, -123, 32.68, -122.05, 33.13, -120.9, 33.15, -120.84, 33.28, -120.49, 33.31, -120.42, 33.41, -120.14, 33.43, -120.09, 33.5, -119.89, 33.59, -119.66, 33.61, -119.6, 33.63, -119.53, 33.66, -119.46, 33.7, -119.34, 33.71, -119.33, 33.71, -119.31, 33.78, -119.13, 33.79, -119.08, 33.82, -119.02, 33.84, -118.96, 33.86, -118.91, 33.86, -118.89, 33.88, -118.85, 33.88, -118.84, 33.89, -118.76, 33.9, -118.69, 33.9, -118.67, 33.92, -118.59, 33.93, -118.5, 33.94, -118.41], 'first_position_time': '2025-06-24T07:41:15Z', 'last_position': {'fa_flight_id': 'UAL1169-1750493041-airline-715p', 'altitude': 197, 'altitude_change': 'C', 'groundspeed': 444, 'heading': 83, 'latitude': 21.29891, 'longitude': -157.00993, 'timestamp': '2025-06-24T08:07:29Z', 'update_type': 'A'}, 'bounding_box': [21.33084, -157.94225, 21.19377, -157.00993], 'ident_prefix': None, 'aircraft_type': 'B772'}], 'links': None, 'num_pages': 1}

def main():
    logger.info("Starting runway extension polygon generation")
    runways = read_json_file("runways.json")

    all_runway_info = []
    all_gj = []

    for runway in runways:
        name = runway["name"]
        runway_info = create_runoff_polygon_latlon(
            start=runway["start"],
            end=runway["end"],
            extension_miles=5.0,
            width_start_miles=0.02,
            width_end_miles=0.15,
        )

        poly, heading, gj = runway_info
        all_gj.append(gj)

        all_runway_info.append((name, poly, heading, gj))

    gj_feature_collection = wrap_as_feature_collection(all_gj)

    write_geojson_file(gj_feature_collection)

    logger.info("Runway extension polygons generated and saved to zones.geojson")

    while True:
        try:
            logger.debug("Cycle Begin")
            # json_response = get_flight_positions() # Switch to real API call when available, (costly API call)
            positions = to_positions(json_response)

            for position in positions:
                callsign = position.get("callsign")
                icao24 = position.get("icao24")

                lat = position.get("lat")
                lon = position.get("lon")
                heading = position.get("heading")

                status = classify_to_la(lat, lon, heading, all_runway_info)

                aircraft_summary = f"Aircraft: {callsign} (HEX {icao24}) at Lat: {lat}, Lon: {lon}, Heading: {heading}, Status: {status}"

                logger.debug(f"Aircraft Classified: {aircraft_summary}")
                if status is None:
                    logger.debug(f"Aircraft {callsign} is not in any runway zone, skipping...")
                    continue

                logger.info(f"IN ZONE: {aircraft_summary}")

            logger.debug("Cycle End")
            time.sleep(10)
        except KeyboardInterrupt:
            logger.info("Exiting...")
            break



if __name__ == "__main__":
    main()